name: Cycode OIDC Final Fix

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cycode-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install requests cycode

      - name: Exchange OIDC Token
        id: exchange
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
          CYCODE_AUTH_URL: "https://api.cycode.com/api/v1/auth/oidc/token"
        run: |
          python -c "
          import os
          import requests
          import sys

          # --- CRITICAL FIX ---
          # We must ask GitHub to sign the token for the EXACT Audience 
          # configured in your Cycode portal.
          audience = 'https://api.cycode.com' 
          # --------------------

          # 1. Get Token from GitHub
          token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')

          if not token or not url:
              print('::error::GitHub OIDC Environment Variables missing')
              sys.exit(1)

          try:
              # Request the token with the CORRECT Audience
              headers = {'Authorization': f'Bearer {token}'}
              resp = requests.get(f'{url}&audience={audience}', headers=headers)
              resp.raise_for_status()
              jwt = resp.json()['value']
              print(f'::notice::Acquired GitHub Token for audience: {audience}')
          except Exception as e:
              print(f'::error::GitHub Token Fetch Error: {e}')
              sys.exit(1)

          # 2. Exchange with Cycode
          # Using the standard 'jwt-bearer' grant type
          payload = {
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'assertion': jwt,
              'clientId': os.environ.get('CYCODE_CLIENT_ID')
          }
          
          # Send token in Header AND Body to cover all validation bases
          headers = {
              'Authorization': f'Bearer {jwt}', 
              'Content-Type': 'application/json'
          }

          try:
              r = requests.post(os.environ.get('CYCODE_AUTH_URL'), json=payload, headers=headers)
              
              if r.status_code == 200:
                  token = r.json().get('token') or r.json().get('access_token')
                  print('::notice::Successfully exchanged Cycode Token!')
                  print(f'::add-mask::{token}')
                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write(f'CYCODE_API_TOKEN={token}\n')
              else:
                  print(f'::error::Exchange Failed [{r.status_code}]: {r.text}')
                  sys.exit(1)
          except Exception as e:
              print(f'::error::Request Error: {e}')
              sys.exit(1)
          "

      - name: Run Cycode Scan
        run: |
          cycode scan path ./ \
            --branch ${{ github.head_ref || github.ref_name }} \
            --sca-scan \
            --iac-scan \
            --secret-scan
