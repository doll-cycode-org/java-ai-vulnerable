name: Cycode OIDC Fix

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cycode-exchange-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: pip install requests

      - name: Attempt Token Exchange (Body Method)
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
          CYCODE_AUTH_URL: "https://api.cycode.com/api/v1/auth/oidc/token"
        run: |
          cat <<EOF > fix_cycode.py
          import os
          import requests
          import sys

          # 1. Get GitHub Token (Audience = cycode-service)
          request_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          request_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')
          audience = 'cycode-service'

          if not request_token:
              print('::error::No OIDC token found.')
              sys.exit(1)

          try:
              headers = {'Authorization': f'Bearer {request_token}'}
              resp = requests.get(f'{request_url}&audience={audience}', headers=headers)
              resp.raise_for_status()
              github_jwt = resp.json()['value']
              print('::notice::GitHub Token Acquired')
          except Exception as e:
              print(f'::error::GitHub OIDC failure: {e}')
              sys.exit(1)

          # 2. Exchange with Cycode (Token in BODY, not Header)
          client_id = os.environ.get('CYCODE_CLIENT_ID', '').strip() # Strip whitespace
          url = os.environ.get('CYCODE_AUTH_URL')

          # Attempt 1: Standard 'idToken' field
          payload_1 = {
              'clientId': client_id,
              'idToken': github_jwt
          }
          
          print(f'Attempting exchange (Payload: idToken)...')
          
          # NOTE: No Authorization header here. We are unauthenticated, asking for a token.
          try:
              res = requests.post(url, json=payload_1)
              
              if res.status_code == 200:
                  print('::notice::SUCCESS! Token exchanged using "idToken" field.')
                  token = res.json().get('token') or res.json().get('access_token')
                  print(f'::add-mask::{token}')
                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write(f'CYCODE_API_TOKEN={token}\n')
                  sys.exit(0) # Exit successfully
              else:
                  print(f'Attempt 1 Failed [{res.status_code}]: {res.text}')
          except Exception as e:
              print(f'Attempt 1 Error: {e}')

          # Attempt 2: Alternative 'assertion' field (RFC 7523 style)
          print(f'Attempting exchange (Payload: assertion)...')
          payload_2 = {
              'clientId': client_id,
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'assertion': github_jwt
          }
          
          try:
              res = requests.post(url, json=payload_2)
              
              if res.status_code == 200:
                  print('::notice::SUCCESS! Token exchanged using "assertion" field.')
                  token = res.json().get('token') or res.json().get('access_token')
                  print(f'::add-mask::{token}')
                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write(f'CYCODE_API_TOKEN={token}\n')
                  sys.exit(0)
              else:
                  print(f'Attempt 2 Failed [{res.status_code}]: {res.text}')
                  sys.exit(1) # Fail if both attempts miss
          except Exception as e:
              print(f'Attempt 2 Error: {e}')
              sys.exit(1)
          EOF
          
          python fix_cycode.py

      - name: Run Cycode Scan
        if: success()
        run: |
          pip install cycode
          cycode scan path ./ \
            --branch ${{ github.head_ref || github.ref_name }} \
            --sca-scan \
            --iac-scan \
            --secret-scan
