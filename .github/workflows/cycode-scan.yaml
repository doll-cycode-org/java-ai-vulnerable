name: Cycode OIDC Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write  # Required to fetch the JWT
  contents: read

jobs:
  cycode-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Cycode CLI
        run: pip install cycode

      # 1. Fetch GitHub OIDC Token (Audience = Client ID)
      - name: Fetch and Set OIDC Token
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
        run: |
          python -c "
          import os
          import requests
          import sys
          # Docs say: Audience must match Client ID
          client_id = 'cycode-service'
          
          # GitHub Actions OIDC Endpoint
          token_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')
          request_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          if not token_url or not request_token:
              print('::error::OIDC Environment variables missing')
              sys.exit(1)
          try:
              # Request token specifically for the Client ID
              headers = {'Authorization': f'Bearer {request_token}'}
              resp = requests.get(f'{token_url}&audience={client_id}', headers=headers)
              resp.raise_for_status()
              jwt = resp.json()['value']
              
              # MASK the token so it doesn't appear in logs
              print(f'::add-mask::{jwt}')
              
              # EXPORT as CYCODE_ID_TOKEN (Standard env var for Cycode CLI)
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f'CYCODE_ID_TOKEN={jwt}\n')
              
              print('::notice::CYCODE_ID_TOKEN has been set.')
          
          except Exception as e:
              print(f'::error::Failed to fetch OIDC token: {e}')
              sys.exit(1)
          "
      # 2. Run Scan (CLI handles the exchange automatically)
      - name: Run Cycode Scan
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
        run: |
          cycode scan --scan-type sca repository . 
