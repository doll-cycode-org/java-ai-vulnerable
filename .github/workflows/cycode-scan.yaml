name: Cycode OIDC Brute Force

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cycode-brute-force:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: pip install requests

      - name: Brute Force OIDC Exchange
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
          CYCODE_AUTH_URL: "https://api.cycode.com/api/v1/auth/oidc/token"
        run: |
          cat <<EOF > brute_cycode.py
          import os
          import requests
          import sys

          # Setup
          request_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')
          request_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          client_id = os.environ.get('CYCODE_CLIENT_ID').strip()
          auth_url = os.environ.get('CYCODE_AUTH_URL')

          def get_github_token(audience_value):
              print(f'\\n[1] Requesting GitHub Token for Audience: {audience_value}')
              headers = {'Authorization': f'Bearer {request_token}'}
              # Fetch token
              try:
                  r = requests.get(f'{request_url}&audience={audience_value}', headers=headers)
                  r.raise_for_status()
                  return r.json()['value']
              except Exception as e:
                  print(f'   Failed to get OIDC token: {e}')
                  return None

          def attempt_exchange(jwt, label):
              print(f'[2] Attempting Cycode Exchange using [{label}] token...')
              
              # Standard OIDC Exchange Payload
              payload = {'clientId': client_id}
              
              # Header MUST contain the JWT
              headers = {
                  'Authorization': f'Bearer {jwt}',
                  'Content-Type': 'application/json'
              }

              resp = requests.post(auth_url, json=payload, headers=headers)
              
              if resp.status_code == 200:
                  print(f'   ✅ SUCCESS! Accepted audience: {label}')
                  token = resp.json().get('token') or resp.json().get('access_token')
                  print(f'::add-mask::{token}')
                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write(f'CYCODE_API_TOKEN={token}\\n')
                  return True
              else:
                  print(f'   ❌ FAILED ({resp.status_code}): {resp.text}')
                  return False

          # --- ATTEMPT 1: Audience = cycode-service ---
          token_service = get_github_token('cycode-service')
          if token_service:
              if attempt_exchange(token_service, 'cycode-service'):
                  sys.exit(0)

          # --- ATTEMPT 2: Audience = Client ID ---
          # This is the standard OIDC requirement, even if UI says otherwise
          token_client = get_github_token(client_id)
          if token_client:
              if attempt_exchange(token_client, 'CLIENT_ID'):
                  sys.exit(0)

          print('\\n::error::All attempts failed.')
          sys.exit(1)
          EOF

          python brute_cycode.py

      - name: Run Cycode Scan
        if: success()
        run: |
          pip install cycode
          cycode scan path ./ \
            --branch ${{ github.head_ref || github.ref_name }} \
            --sca-scan \
            --iac-scan \
            --secret-scan
