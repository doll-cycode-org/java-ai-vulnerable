name: Cycode OIDC Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 1. Essential: Allow the workflow to request the OIDC token
permissions:
  id-token: write
  contents: read

jobs:
  cycode-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Python (for helper script)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 2. Fetch the GitHub OIDC Token and Exchange for Cycode Token
      - name: Generate Cycode Access Token
        id: cycode_auth
        env:
          # You typically need a Client ID provided by Cycode for the OIDC integration
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }} 
          # The API Endpoint for your specific Cycode tenant
          CYCODE_AUTH_URL: "https://api.cycode.com/api/v1/auth/oidc/token" 
        run: |
          pip install requests
          
          python -c "
          import os
          import requests
          import sys

          # A. Get the GitHub OIDC Token
          # GitHub Actions exposes the URL and Token for the OIDC service in env vars
          request_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          request_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')

          if not request_token or not request_url:
              print('::error::OIDC Environment variables not found.')
              sys.exit(1)

          headers = {'Authorization': f'Bearer {request_token}'}
          # Usually, you request a specific audience (aud) matching your Cycode config
          audience = 'cycode-service' 
          
          try:
              oidc_response = requests.get(f'{request_url}&audience={audience}', headers=headers)
              oidc_response.raise_for_status()
              github_jwt = oidc_response.json()['value']
              print('::notice::Successfully retrieved GitHub OIDC Token')
          except Exception as e:
              print(f'::error::Failed to get GitHub OIDC Token: {e}')
              sys.exit(1)

          # B. Exchange GitHub JWT for Cycode Access Token
          # Note: The payload structure depends on Cycode's specific API requirements
          payload = {
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'client_id': os.environ.get('CYCODE_CLIENT_ID'),
              'assertion': github_jwt
          }

          try:
              cycode_response = requests.post(os.environ.get('CYCODE_AUTH_URL'), json=payload)
              cycode_response.raise_for_status()
              cycode_token = cycode_response.json()['access_token']
              
              # C. Export the token as a masked environment variable for next steps
              # This ensures the token is redacted in logs
              print(f'::add-mask::{cycode_token}')
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f'CYCODE_API_TOKEN={cycode_token}\n')
              
              print('::notice::Successfully authenticated with Cycode')
          except Exception as e:
              print(f'::error::Failed to exchange token with Cycode: {e}')
              print(f'Response: {cycode_response.text if 'cycode_response' in locals() else 'N/A'}')
              sys.exit(1)
          "

      # 3. Run the Scan using the generated Token
      - name: Install Cycode CLI
        run: pip install cycode

      - name: Run Cycode Scan
        # The CLI usually looks for CYCODE_API_TOKEN by default
        run: |
          cycode scan path ./ \
            --branch ${{ github.head_ref || github.ref_name }} \
            --sca-scan \
            --iac-scan \
            --secret-scan
