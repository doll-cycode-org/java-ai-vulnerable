name: Cycode OIDC Debug Scan

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cycode-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: pip install requests pyjwt

      - name: Debug OIDC & Exchange
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
          CYCODE_AUTH_URL: "https://api.cycode.com/api/v1/auth/oidc/token"
        run: |
          python -c "
          import os
          import requests
          import sys
          import jwt

          # --- CONFIGURATION ---
          # We must match the Audience you locked in Cycode
          audience = 'cycode-service'
          # ---------------------

          # 1. Get GitHub Token
          request_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          request_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')

          if not request_token:
              print('::error::No OIDC token found. Check permissions.')
              sys.exit(1)

          try:
              # Request Token
              headers = {'Authorization': f'Bearer {request_token}'}
              resp = requests.get(f'{request_url}&audience={audience}', headers=headers)
              resp.raise_for_status()
              jwt_token = resp.json()['value']

              # --- CRITICAL DEBUGGING ---
              # Verify exactly what GitHub is sending vs what Cycode expects
              decoded = jwt.decode(jwt_token, options={'verify_signature': False})
              print('\n============= TOKEN INSPECTION =============')
              print(f' 1. Iss (Issuer):   {decoded.get(\'iss\')}')
              print(f' 2. Aud (Audience): {decoded.get(\'aud\')}')
              print(f' 3. Sub (Subject):  {decoded.get(\'sub\')}')
              print('============================================\n')
              
              print(f'::notice::Token Subject is: {decoded.get(\'sub\')}')
              # --------------------------

          except Exception as e:
              print(f'::error::GitHub Token Fetch Error: {e}')
              sys.exit(1)

          # 2. Exchange with Cycode
          try:
              # Sending BOTH formats to be safe
              payload = {
                  'clientId': os.environ.get('CYCODE_CLIENT_ID'),
                  'client_id': os.environ.get('CYCODE_CLIENT_ID')
              }
              
              # Token goes in Header
              auth_headers = {
                  'Authorization': f'Bearer {jwt_token}',
                  'Content-Type': 'application/json'
              }

              print(f'Attempting exchange with Aud: {audience}...')
              cy_resp = requests.post(os.environ.get('CYCODE_AUTH_URL'), json=payload, headers=auth_headers)
              
              if cy_resp.status_code == 200:
                  print('::notice::SUCCESS! Token exchanged.')
                  print(f'Response keys: {cy_resp.json().keys()}')
              else:
                  print(f'::error::Exchange Failed [{cy_resp.status_code}]')
                  print(f'Response Body: {cy_resp.text}')
                  sys.exit(1)

          except Exception as e:
              print(f'::error::Exchange Script Error: {e}')
              sys.exit(1)
          "
