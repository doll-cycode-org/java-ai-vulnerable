name: Cycode OIDC Scan
on:
  push:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Crucial: allows requesting the JWT
      contents: read   # Allows checking out code

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug OIDC Response
        run: |
          # Request the token and save to a file
          curl -v -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=https://app.cycode.com" \
            -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" > github_response.txt 2>&1
          
          echo "--- START OF RESPONSE ---"
          cat github_response.txt
          echo "--- END OF RESPONSE ---"   

      - name: Get Cycode Token
        id: auth
        run: |
          AUDIENCE="https://app.cycode.com"
          
          # 1. Fetch GitHub JWT and save to file
          curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}" \
            -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" > github_jwt.json

          cat github_jwt.json 
          
          # 2. Extract JWT value safely
          ID_TOKEN=$(jq -r '.value' github_jwt.json)
          
          # 3. Create Cycode Payload (Quoted 'EOF' prevents shell expansion of ***)
          cat <<'EOF' > cycode_payload.json
          {
            "token": "$ID_TOKEN"
          }
          EOF
          
          # Use sed to manually swap the variable name for the token to avoid shell 'echo'
          sed -i "s|\$ID_TOKEN|$ID_TOKEN|g" cycode_payload.json

          # 4. Exchange for Cycode Access Token
          CYCODE_RESP=$(curl -s -X POST "https://api.cycode.com/api/v1/auth/oidc" \
            -H "Content-Type: application/json" \
            -d @cycode_payload.json)
          
          # 5. Extract and mask
          CYCODE_TOKEN=$(echo "$CYCODE_RESP" | jq -r '.access_token')
          
          if [ "$CYCODE_TOKEN" == "null" ] || [ -z "$CYCODE_TOKEN" ]; then
            echo "::error::Cycode exchange failed. Response: $CYCODE_RESP"
            exit 1
          fi

          echo "::add-mask::$CYCODE_TOKEN"
          echo "token=$CYCODE_TOKEN" >> $GITHUB_OUTPUT
      
      - name: Run Cycode CLI Scan
        run: |
          # Install Cycode CLI (assuming pip)
          pip install cycode
          
          # Use the token from the previous step
          export CYCODE_API_TOKEN=${{ steps.auth.outputs.token }}
          cycode scan repository .
