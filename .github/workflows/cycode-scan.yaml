name: Cycode OIDC Debug Scan

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cycode-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: pip install requests pyjwt

      - name: Debug OIDC & Exchange
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
          CYCODE_AUTH_URL: "https://api.cycode.com/api/v1/auth/oidc/token"
        run: |
          # 1. Write the Python script to a file (avoids quoting errors)
          cat <<EOF > debug_cycode.py
          import os
          import requests
          import sys
          import jwt

          # --- CONFIGURATION ---
          audience = 'cycode-service'
          # ---------------------

          # 1. Get GitHub Token
          request_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')
          request_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')

          if not request_token:
              print('::error::No OIDC token found. Check permissions.')
              sys.exit(1)

          try:
              # Request Token
              headers = {'Authorization': f'Bearer {request_token}'}
              resp = requests.get(f'{request_url}&audience={audience}', headers=headers)
              resp.raise_for_status()
              jwt_token = resp.json()['value']

              # --- CRITICAL DEBUGGING ---
              decoded = jwt.decode(jwt_token, options={'verify_signature': False})
              print('\n============= TOKEN INSPECTION =============')
              print(f" 1. Iss (Issuer):   {decoded.get('iss')}")
              print(f" 2. Aud (Audience): {decoded.get('aud')}")
              print(f" 3. Sub (Subject):  {decoded.get('sub')}")
              print('============================================\n')
              
              # 2. Exchange with Cycode
              # Sending BOTH formats (clientId and client_id) to cover API variances
              payload = {
                  'clientId': os.environ.get('CYCODE_CLIENT_ID'),
                  'client_id': os.environ.get('CYCODE_CLIENT_ID')
              }
              
              auth_headers = {
                  'Authorization': f'Bearer {jwt_token}',
                  'Content-Type': 'application/json'
              }

              print(f'Attempting exchange with Aud: {audience}...')
              cy_resp = requests.post(os.environ.get('CYCODE_AUTH_URL'), json=payload, headers=auth_headers)
              
              if cy_resp.status_code == 200:
                  print('::notice::SUCCESS! Token exchanged.')
                  # Safely grab the token
                  data = cy_resp.json()
                  token = data.get('token') or data.get('access_token')
                  
                  # Register the token for the next step
                  print(f'::add-mask::{token}')
                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write(f'CYCODE_API_TOKEN={token}\n')
              else:
                  print(f'::error::Exchange Failed [{cy_resp.status_code}]')
                  print(f'Response Body: {cy_resp.text}')
                  sys.exit(1)

          except Exception as e:
              print(f'::error::Script Error: {e}')
              sys.exit(1)
          EOF

          # 2. Run the script
          python debug_cycode.py

      - name: Run Cycode Scan
        # Only runs if the previous step succeeded
        if: success()
        run: |
          pip install cycode
          cycode scan path ./ \
            --branch ${{ github.head_ref || github.ref_name }} \
            --sca-scan \
            --iac-scan \
            --secret-scan
