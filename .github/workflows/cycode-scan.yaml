name: Cycode OIDC Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  cycode-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install requests cycode

      - name: Fetch & Configure OIDC
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
        run: |
          python -c "
          import os
          import requests
          import sys

          # --- CONFIGURATION ---
          # 1. This MUST match the 'Audience' field in your Cycode UI exactly.
          #    Try 'cycode-service' first. If that fails, try 'https://api.cycode.com'
          target_audience = 'cycode-service'
          # ---------------------

          # 1. Get GitHub Token
          token_url = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_URL')
          req_token = os.environ.get('ACTIONS_ID_TOKEN_REQUEST_TOKEN')

          if not token_url or not req_token:
              print('::error::OIDC Env Vars missing')
              sys.exit(1)

          try:
              # Request token with the correct audience
              headers = {'Authorization': f'Bearer {req_token}'}
              resp = requests.get(f'{token_url}&audience={target_audience}', headers=headers)
              resp.raise_for_status()
              jwt = resp.json()['value']
              
              # 2. Export for CLI
              # The CLI detects this variable and uses it for authentication automatically
              print(f'::add-mask::{jwt}')
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f'CYCODE_ID_TOKEN={jwt}\n')
              
              print(f'::notice::Token acquired for Audience: {target_audience}')

          except Exception as e:
              print(f'::error::Token Fetch Failed: {e}')
              sys.exit(1)
          "

      - name: Run Cycode Scan
        env:
          CYCODE_CLIENT_ID: ${{ secrets.CYCODE_CLIENT_ID }}
        run: |
          cycode scan --scan-type secret path .
