name: Cycode OIDC Scan
on:
  push:
    branches: [ main ]

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Crucial: allows requesting the JWT
      contents: read   # Allows checking out code

    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Get Cycode Token
        id: auth
        run: |
          AUDIENCE="https://app.cycode.com"
          
          # 1. Fetch GitHub JWT
          # We use -f to make curl fail on 4XX/5XX errors
          RESPONSE=$(curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}" \
            -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}")
          
          # Check if GitHub returned valid JSON
          if ! echo "$RESPONSE" | jq -e . > /dev/null 2>&1; then
            echo "::error::GitHub OIDC failed. Message: $RESPONSE"
            exit 1
          fi
          ID_TOKEN=$(echo "$RESPONSE" | jq -r '.value')

          # 2. Exchange for Cycode Access Token
          CYCODE_RESP=$(curl -s -X POST "https://api.cycode.com/api/v1/auth/oidc" \
            -H "Content-Type: application/json" \
            -d "{\"token\": \"$ID_TOKEN\"}")
          
          # Check if Cycode accepted the token
          CYCODE_TOKEN=$(echo "$CYCODE_RESP" | jq -r '.access_token // empty')
          
          if [ -z "$CYCODE_TOKEN" ]; then
            echo "::error::Cycode rejected the token. Response: $CYCODE_RESP"
            exit 1
          fi

          echo "::add-mask::$CYCODE_TOKEN"
          echo "token=$CYCODE_TOKEN" >> $GITHUB_OUTPUT
      - name: Run Cycode CLI Scan
        run: |
          # Install Cycode CLI (assuming pip)
          pip install cycode
          
          # Use the token from the previous step
          export CYCODE_API_TOKEN=${{ steps.auth.outputs.token }}
          cycode scan repository .
